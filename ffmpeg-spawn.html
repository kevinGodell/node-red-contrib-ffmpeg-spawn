<script type="text/javascript">
  // register node
  RED.nodes.registerType('ffmpeg-spawn', {
    align: 'left',
    category: 'cctv',
    color: '#DEBD5C',
    defaults: {
      name: {
        value: '',
      },
      outputs: {
        value: 1,
      },
      migrate: {
        // migration versioning
        // flag for adding new defaults
        value: 0.000000002,
      },
      cmdPath: {
        value: RED.settings.ffmpegSpawn.cmdPath,
        validate: function (cmdPath) {
          return cmdPath === '' || /^\s*$|ffmpeg/i.test(cmdPath);
        },
      },
      cmdArgs: {
        value: JSON.stringify(['-version']),
        validate: function (cmdArgs) {
          try {
            return Array.isArray(JSON.parse(cmdArgs));
          } catch (e) {
            return false;
          }
        },
      },
      cmdOutputs: {
        value: 0,
        validate: function (cmdOutputs) {
          return cmdOutputs >= 0 && cmdOutputs <= RED.settings.ffmpegSpawn.cmdOutputsMax;
        },
      },
      killSignal: {
        value: 'SIGTERM',
        validate: function (killSignal) {
          return ['SIGHUP', 'SIGINT', 'SIGKILL', 'SIGTERM'].includes(killSignal);
        },
      },
      msgOutput: {
        value: 'split',
        validate: function (msgOutput) {
          return ['split', 'combined'].includes(msgOutput);
        },
      },
    },
    paletteLabel: 'ffmpeg',
    icon: 'font-awesome/fa-file-video-o',
    inputs: 1,
    outputs: 1,
    label: function () {
      return this.name || this.type;
    },
    inputLabels: function () {
      return 'stdin';
    },
    outputLabels: function (index) {
      if (this.msgOutput === 'combined') {
        return 'output';
      }
      switch (index) {
        case 0:
          return 'status';
        case 1:
          return 'stdout';
        case 2:
          return 'stderr';
        default:
          return `stdio${index}`;
      }
    },
    oneditprepare: function () {
      const cmdPathPlaceholder = RED.settings.ffmpegSpawn.cmdPath;
      const cmdPath = $('#node-input-cmdPath')
        .prop('placeholder', cmdPathPlaceholder)
        .prop('title', this.cmdPath || cmdPathPlaceholder)
        .on('input', function () {
          this.value = this.value.trim();
          this.title = this.value || cmdPathPlaceholder;
        });

      const cmdArgs = $('#node-input-cmdArgs')
        .typedInput({ types: ['json'] })
        .on('change', function (event, type, value) {
          const val = $(this).typedInput('value').trim();
          if (val === '') {
            $(this).typedInput('value', '[]');
          }
        });

      const cmdOutputsMin = 0;
      const cmdOutputsMax = RED.settings.ffmpegSpawn.cmdOutputsMax;
      const cmdOutputs = $('#node-input-cmdOutputs').spinner({
        min: cmdOutputsMin,
        max: cmdOutputsMax,
        step: 1,
        change: function (event, ui) {
          let value = parseInt(this.value);
          if (Number.isNaN(value) || value < cmdOutputsMin) {
            value = cmdOutputsMin;
          } else if (value > cmdOutputsMax) {
            value = cmdOutputsMax;
          }
          this.value = value;
        },
      });

      const killSignal = $('#node-input-killSignal').typedInput({
        types: [
          {
            value: 'str',
            icon: 'fa fa-times',
            options: ['SIGHUP', 'SIGINT', 'SIGKILL', 'SIGTERM'],
          },
        ],
      });

      const msgOutput = $('#node-input-msgOutput').typedInput({
        types: [
          {
            value: 'str',
            icon: ['fa fa-envelope'],
            options: ['split', 'combined'],
          },
        ],
      });

      // migration code start
      if (typeof this.migrate === 'undefined' || this.migrate < this._def.defaults.migrate.value) {
        this.migrate = this._def.defaults.migrate.value;
        this.msgOutput = this._def.defaults.msgOutput.value;
        msgOutput.typedInput('value', this.msgOutput);
      }
      // migration code end

      $('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-book"></i> help</button>')
        .on('click', () => {
          RED.sidebar.help.show(this.type);
        })
        .appendTo($('div.red-ui-tray-footer'));
    },
    oneditsave: function () {
      this.cmdOutputs = $('#node-input-cmdOutputs').spinner('value');
      this.msgOutput = $('#node-input-msgOutput').typedInput('value');
      this.outputs = this.msgOutput === 'combined' ? 1 : this.cmdOutputs + 1;
    },
    onpaletteadd: function () {
      console.log('paletteadd', this);
    },
  });
</script>

<script data-template-name="ffmpeg-spawn" type="text/html">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>

  <fieldset>
    <legend>spawn options</legend>

    <div class="form-row">
      <label for="node-input-cmdPath"><i class="fa fa-terminal"></i> Path</label>
      <input type="text" id="node-input-cmdPath" />
    </div>

    <div class="form-row">
      <label for="node-input-cmdArgs"><i class="fa fa-gears"></i> Args</label>
      <input id="node-input-cmdArgs" />
    </div>

    <div class="form-row">
      <label for="node-input-cmdOutputs"><i class="fa fa-random"></i> Outputs</label>
      <input id="node-input-cmdOutputs" />
    </div>
  </fieldset>

  <fieldset>
    <legend>close options</legend>

    <div class="form-row">
      <label for="node-input-killSignal"><i class="fa fa-times"></i> Signal</label>
      <input id="node-input-killSignal" />
    </div>
  </fieldset>

  <fieldset>
    <legend>message options</legend>

    <div class="form-row">
      <label for="node-input-msgOutput"><i class="fa fa-envelope"></i> Output</label>
      <input id="node-input-msgOutput" />
    </div>
  </fieldset>
</script>

<script data-help-name="ffmpeg-spawn" type="text/html">
  <ul>
    <li>spawns a long running <a href="https://ffmpeg.org/">ffmpeg</a> process to handle video/image processing</li>
    <li>designed to be a thin wrapper around ffmpeg using <a href="https://nodejs.org/api/child_process.html#child_process_child_process_spawn_command_args_options">child_process.spawn</a></li>
    <li>ffmpeg executable binary must be installed or built separately</li>
  </ul>

  <h1>Inputs</h1>
  <ul>
    <li>
      <h2>Buffer: video/image</h2>
      <ul>
        <li>buffer can be written to ffmpeg's stdin pipe</li>
        <li>ffmpeg's input must be set to stdin <em>-i pipe:0</em></li>
      </ul>
      <p>Send an input <code>msg</code> structured as:</p>
      <pre class="form-tips" style="min-width: 450px"><code>
{
  payload: &lt;Buffer&gt;
}
       </code></pre>
    </li>
    <li>
      <h2>Command: start</h2>
      <ul>
        <li>starts the ffmpeg process</li>
        <li>has no effect if it is already running</li>
        <li>optional properties: path, args, outputs, topics</li>
        <li>message output must be set to <strong>combined</strong> for <em>outputs</em> and <em>topics</em> to be used here</li>
      </ul>
      <p>Send an input <code>msg</code> structured as:</p>
      <pre class="form-tips" style="min-width: 450px"><code>
{
  action: {
    command: 'start'
    // path: 'ffmpeg',
    // args: ['-loglevel', 'trace', '-version'],
    // outputs: 2,
    // topics: ['version', 'logs']
  }
}
      </code></pre>
    </li>
    <li>
      <h2>Command: stop</h2>
      <ul>
        <li>stops the ffmpeg process</li>
        <li>has no effect if it is not running</li>
        <li>optional properties: signal</li>
      </ul>
      <p>Send an input <code>msg</code> structured as:</p>
      <pre class="form-tips" style="min-width: 450px"><code>
{
  action: {
    command: 'stop',
    // signal: 'SIGKILL'
  }
}
      </code></pre>
    </li>
    <li>
      <h2>Command: restart</h2>
      <ul>
        <li>restarts the ffmpeg process</li>
        <li>convenience command that triggers stop followed by start</li>
        <li>optional properties: path, args, outputs, topics, signal</li>
        <li>message output must be set to <strong>combined</strong> for <em>outputs</em> and <em>topics</em> to be used here</li>
      </ul>
      <p>Send an input <code>msg</code> structured as:</p>
      <pre class="form-tips" style="min-width: 450px"><code>
{
  action: {
    command: 'restart',
    // path: 'ffmpeg',
    // args: ['-loglevel', 'trace', '-version'],
    // outputs: 2,
    // topics: ['version', 'logs'],
    // signal: 'SIGKILL'
  }
}
      </code></pre>
    </li>
  </ul>

  <dl class="message-properties">
    <dt class="required">command<span class="property-type">string</span></dt>
    <dd>example: 'start'</dd>
    <dd>accepts: 'start' | 'stop' | 'restart'</dd>
    <dd>Start, stop, or restart the ffmpeg process.</dd>

    <dt class="optional">path<span class="property-type">string</span></dt>
    <dd>example: '/home/pi/.node-red/node_modules/ffmpeg-for-homebridge/ffmpeg'</dd>
    <dd>Path to the ffmpeg executable binary.</dd>

    <dt class="optional">args<span class="property-type">array</span></dt>
    <dd>example: ['-loglevel', 'trace', '-version']</dd>
    <dd>Arguments passed to the ffmpeg process.</dd>

    <dt class="optional">outputs<span class="property-type">number</span></dt>
    <dd>example: 3</dd>
    <dd>accepts: 0 to 5</dd>
    <dd>Number of stdio output pipes to attach to the ffmpeg process.</dd>
    <dd>For example, if stdout, stderr, and stdio[3] are needed for piping, set value to 3.</dd>
    <dd>Message output must be set to <strong>combined</strong> to use this property with the action command.</dd>

    <dt class="optional">topics<span class="property-type">array</span></dt>
    <dd>example: ['mp4', 'logs', 'jpeg', 'progress']</dd>
    <dd>Array must only contain unique strings and be the same length as outputs.</dd>
    <dd>If not set, defaults to ['stdout', 'stderr', 'stdio3', 'stdio4', ...].</dd>
    <dd>Message output must be set to <strong>combined</strong> to use this property with the action command.</dd>
  </dl>

  <h1>Outputs</h1>
  <ol>
    <li>
      <h2>Status</h2>
      <ul>
        <li>topic will be 'status'</li>
        <li>payload will have property status: 'spawn' | 'close' | 'error'</li>
        <li>additional payload properties: pid, code, signal, killed, error</li>
      </ul>
      <p>Sends an output <code>msg</code> structured as:</p>
      <pre class="form-tips" style="min-width: 450px"><code>
{
  topic: 'status',
  payload: {
    status: 'spawn',
    pid: 12345
  }
}
      </code></pre>
      <pre class="form-tips" style="min-width: 450px"><code>
{
  topic: 'status',
  payload: {
    status: 'close',
    pid: 12345,
    code: 255,
    signal: null,
    killed: true
  }
}
      </code></pre>
      <pre class="form-tips" style="min-width: 450px"><code>
{
  topic: 'status',
  payload: {
    status: 'error',
    error: 'Error: spawn ffmpeg ENOENT'
  }
}
      </code></pre>
    </li>
    <li>
      <h2>Buffer</h2>
      <ul>
        <li>topic can be 'stdout' | 'stderr' | 'stdio3' | 'stdio4' | 'custom_name' | etc.</li>
        <li>if message output is set to <strong>combined</strong>, output topics can be changed via input</li>
      </ul>
      <p>Sends an output <code>msg</code> structured as:</p>
      <pre class="form-tips" style="min-width: 450px"><code>
{
  topic: 'stdout',
  payload: &lt;Buffer&gt;
}
      </code></pre>
      <pre class="form-tips" style="min-width: 450px"><code>
{
  topic: 'pipe4',
  payload: &lt;Buffer&gt;
}
      </code></pre>
      <pre class="form-tips" style="min-width: 450px"><code>
{
  topic: 'custom_name',
  payload: &lt;Buffer&gt;
}
      </code></pre>
    </li>
  </ol>

  <h1>Properties</h1>

  <h2>Spawn options</h2>

  <p><code>Path</code></p>
  <ul>
    <li>path to the ffmpeg executable binary</li>
    <li>can be overridden via the input message</li>
  </ul>

  <p><code>Args</code></p>
  <ul>
    <li>arguments passed to the ffmpeg process</li>
    <li>can be overridden via the input message</li>
  </ul>

  <p><code>Outputs</code></p>
  <ul>
    <li>number of stdio output pipes to attach to the ffmpeg process</li>
    <li>can be overridden via the input message if message output set to <strong>combined</strong></li>
  </ul>

  <h2>Close options</h2>

  <p><code>Signal</code></p>
  <ul>
    <li>kill signal used when closing the ffmpeg process</li>
    <li>can be overridden via the input message</li>
  </ul>

  <h2>Message options</h2>

  <p><code>Output</code></p>
  <ul>
    <li>node output messages can be combined or split</li>
    <li>if set to <strong>combined</strong>, then filter output by topic</li>
    <li>if set to <strong>split</strong>, then wire nodes to distinct outputs</li>
  </ul>

  <h1>Settings</h1>

  <h2>Configured in <a href="https://nodered.org/docs/user-guide/runtime/settings-file">settings.js</a></h2>

  <p><code>cmdPath</code></p>
  <ul>
    <li>default path to ffmpeg</li>
  </ul>

  <p><code>cmdOutputsMax</code></p>
  <ul>
    <li>maximum stdio output pipes</li>
  </ul>

  <pre class="form-tips" style="min-width: 450px"><code>
{
  ffmpegSpawn: {
    cmdPath: '/path/to/ffmpeg',
    cmdOutputsMax: 10
  }
}
  </code></pre>
</script>
