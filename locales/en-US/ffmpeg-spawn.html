<script data-help-name="ffmpeg-spawn" type="text/html">
  <p>Spawn a long running <a href="https://ffmpeg.org/">ffmpeg</a> process to handle video/image processing.</p>
  <ul>
    <li>designed to be a thin wrapper around ffmpeg using <a href="https://nodejs.org/api/child_process.html#child_process_child_process_spawn_command_args_options">child_process.spawn</a></li>
    <li>ffmpeg executable binary must be installed or built separately</li>
  </ul>

  <h3>Inputs</h3>
  <ul>
    <li>
      <h4>Buffer: video/image</h4>
      <ul>
        <li>buffer can be written to ffmpeg's stdin pipe</li>
        <li>ffmpeg's input must be set to stdin <em>-i pipe:0</em></li>
        <li>
          <p>Send an input <code>msg</code> structured as:</p>
          <pre class="form-tips" style="min-width: 450px"><code>
{
  payload: &lt;Buffer&gt;
}
          </code></pre>
        </li>
      </ul>
    </li>
    <li>
      <h4>Command: start</h4>
      <ul>
        <li>starts the ffmpeg process</li>
        <li>has no effect if it is already running</li>
        <li>optional properties: path, args, outputs, topics</li>
        <li>message output must be set to <strong>combined</strong> for <em>outputs</em> and <em>topics</em> to be used here</li>
        <li>
          <p>Send an input <code>msg</code> structured as:</p>
          <pre class="form-tips" style="min-width: 450px"><code>
{
  action: {
    command: 'start'
    // path: 'ffmpeg',
    // args: ['-loglevel', 'trace', '-version'],
    // outputs: 2,
    // topics: ['version', 'logs']
  }
}
          </code></pre>
        </li>
      </ul>
    </li>
    <li>
      <h4>Command: stop</h4>
      <ul>
        <li>stops the ffmpeg process</li>
        <li>has no effect if it is not running</li>
        <li>optional properties: signal</li>
        <li>
          <p>Send an input <code>msg</code> structured as:</p>
          <pre class="form-tips" style="min-width: 450px"><code>
{
  action: {
    command: 'stop',
    // signal: 'SIGKILL'
  }
}
          </code></pre>
        </li>
      </ul>
    </li>
    <li>
      <h4>Command: restart</h4>
      <ul>
        <li>restarts the ffmpeg process</li>
        <li>convenience command that triggers stop followed by start</li>
        <li>optional properties: signal, path, args, outputs, topics</li>
        <li>message output must be set to <strong>combined</strong> for <em>outputs</em> and <em>topics</em> to be used here</li>
        <li>
          <p>Send an input <code>msg</code> structured as:</p>
          <pre class="form-tips" style="min-width: 450px"><code>
{
  action: {
    command: 'restart',
    // signal: 'SIGKILL'
    // path: 'ffmpeg',
    // args: ['-loglevel', 'trace', '-version'],
    // outputs: 2,
    // topics: ['version', 'logs']

  }
}
          </code></pre>
          <dl class="message-properties">
            <dt class="required">command<span class="property-type">string</span></dt>
            <dd>example: 'start'</dd>
            <dd>accepts: 'start' | 'stop' | 'restart'</dd>
            <dd>Start, stop, or restart the ffmpeg process.</dd>
            <dt class="optional">path<span class="property-type">string</span></dt>
            <dd>example: '/home/pi/.node-red/node_modules/ffmpeg-for-homebridge/ffmpeg'</dd>
            <dd>Path to the ffmpeg executable binary.</dd>
            <dt class="optional">args<span class="property-type">array</span></dt>
            <dd>example: ['-loglevel', 'trace', '-version']</dd>
            <dd>Arguments passed to the ffmpeg process.</dd>
            <dt class="optional">outputs<span class="property-type">number</span></dt>
            <dd>example: 3</dd>
            <dd>accepts: 0 to 5</dd>
            <dd>Number of stdio output pipes to attach to the ffmpeg process.</dd>
            <dd>For example, if stdout, stderr, and stdio[3] are needed for piping, set value to 3.</dd>
            <dd>Message output must be set to <strong>combined</strong> to use this property with the action command.</dd>
            <dt class="optional">topics<span class="property-type">array</span></dt>
            <dd>example: ['mp4', 'logs', 'jpeg', 'progress']</dd>
            <dd>Array must only contain unique strings and be the same length as outputs.</dd>
            <dd>If not set, defaults to ['stdout', 'stderr', 'stdio3', 'stdio4', ...].</dd>
            <dd>Message output must be set to <strong>combined</strong> to use this property with the action command.</dd>
          </dl>
        </li>
      </ul>
    </li>
  </ul>

  <h3>Outputs</h3>
  <ul>
    <li>
      <h4>Status</h4>
      <ul>
        <li>topic will be 'status'</li>
        <li>payload will have property status: 'spawn' | 'close' | 'error'</li>
        <li>additional payload properties: pid, code, signal, killed, error</li>
        <li>
          <p>Sends an output <code>msg</code> structured as:</p>
          <pre class="form-tips" style="min-width: 450px"><code>
{
  topic: 'status',
  payload: {
    status: 'spawn',
    pid: 12345
  }
}
          </code></pre>
          <pre class="form-tips" style="min-width: 450px"><code>
{
  topic: 'status',
  payload: {
    status: 'close',
    pid: 12345,
    code: 255,
    signal: null,
    killed: true
  }
}
          </code></pre>
          <pre class="form-tips" style="min-width: 450px"><code>
{
  topic: 'status',
  payload: {
    status: 'error',
    error: 'Error: spawn ffmpeg ENOENT'
  }
}
          </code></pre>
        </li>
      </ul>
    </li>
    <li>
      <h4>Buffer</h4>
      <ul>
        <li>topic can be 'stdout' | 'stderr' | 'stdio3' | 'stdio4' | 'custom_name' | etc.</li>
        <li>if message output is set to <strong>combined</strong>, output topics can be changed via input</li>
        <li>
          <p>Sends an output <code>msg</code> structured as:</p>
          <pre class="form-tips" style="min-width: 450px"><code>
{
  topic: 'stdout',
  payload: &lt;Buffer&gt;
}
          </code></pre>
          <pre class="form-tips" style="min-width: 450px"><code>
{
  topic: 'pipe4',
  payload: &lt;Buffer&gt;
}
          </code></pre>
          <pre class="form-tips" style="min-width: 450px"><code>
{
  topic: 'custom_name',
  payload: &lt;Buffer&gt;
}
          </code></pre>
        </li>
      </ul>
    </li>
  </ul>

  <h3>Properties</h3>
  <ul>
    <li>
      <h4>Spawn options</h4>
      <ul>
        <li>
          <h5>Path</h5>
          <ul>
            <li>path to the ffmpeg executable binary</li>
            <li>can be overridden via the input message</li>
            <li>default can be set in settings.js</li>
          </ul>
        </li>
        <li>
          <h5>Args</h5>
          <ul>
            <li>arguments passed to the ffmpeg process</li>
            <li>can be overridden via the input message</li>
          </ul>
        </li>
        <li>
          <h5>Outputs</h5>
          <ul>
            <li>number of stdio output pipes to attach to the ffmpeg process</li>
            <li>can be overridden via the input message if message output set to <strong>combined</strong></li>
          </ul>
        </li>
      </ul>
    </li>
    <li>
      <h4>Close options</h4>
      <ul>
        <li>
          <h5>Signal</h5>
          <ul>
            <li>kill signal used when closing the ffmpeg process</li>
            <li>can be overridden via the input message</li>
          </ul>
        </li>
      </ul>
    </li>
    <li>
      <h4>Message options</h4>
      <ul>
        <li>
          <h5>Output</h5>
          <ul>
            <li>node output messages can be combined or split</li>
            <li>if set to <strong>combined</strong>, then filter output by topic</li>
            <li>if set to <strong>split</strong>, then wire nodes to distinct outputs</li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>

  <h3>Settings</h3>
  <p style="margin-left: 15px">Configured in <a href="https://nodered.org/docs/user-guide/runtime/settings-file">settings.js</a></p>
  <pre class="form-tips" style="min-width: 450px; margin-left: 15px"><code>
{
  ffmpegSpawn: {
    cmdPath: '/path/to/ffmpeg',
    cmdOutputsMax: 10
  }
}
  </code></pre>
  <ul>
    <li>
      <h4><code>cmdPath</code></h4>
      <ul>
        <li>default path to ffmpeg</li>
      </ul>
    </li>
    <li>
      <h4><code>cmdOutputsMax</code></h4>
      <ul>
        <li>maximum stdio output pipes</li>
      </ul>
    </li>
  </ul>
</script>
